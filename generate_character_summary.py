"""
ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ç‰©èªã‹ã‚‰å…¨ç™»å ´äººç‰©ã‚’æŠ½å‡ºã—ã€
å„äººç‰©ã®ç‰¹å¾´ã¨å½¹å‰²ã‚’å«ã‚€ã‚ã‚‰ã™ã˜ã‚’GPT-5.1ã§ç”Ÿæˆã—ã¾ã™ã€‚

ç”Ÿæˆã•ã‚ŒãŸã‚ã‚‰ã™ã˜ã¯ä»¥ä¸‹ã®ç”¨é€”ã§ä½¿ç”¨ã•ã‚Œã¾ã™:
- è³ªå•ãŒç™»å ´äººç‰©ã«é–¢ã™ã‚‹ã‚‚ã®ã‹ã®åˆ¤å®š
- è³ªå•ã®ä¸­å¿ƒã¨ãªã‚‹äººç‰©ã®ç‰¹å®š

ä½¿ç”¨æ–¹æ³•:
    python generate_character_summary.py

å‡ºåŠ›:
    - character_summary.txt: ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜
"""

import os
import json
from pathlib import Path
from dotenv import load_dotenv
import openai

# ç’°å¢ƒå¤‰æ•°èª­ã¿è¾¼ã¿
load_dotenv()
api_key = os.getenv("OPENAI_API_KEY")
if not api_key:
    print("âŒ OPENAI_API_KEY ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“")
    exit(1)

client = openai.OpenAI(api_key=api_key)

# ===============================================
#  å°èª¬ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
# ===============================================
def load_story(filename="beast_text.json"):
    """å°èª¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€"""
    try:
        with open(filename, "r", encoding="utf-8") as f:
            story_sections = json.load(f)

        # å…¨ç« ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’çµåˆ
        story_text = "\n\n".join([
            f"ã€{sec['section']}ç« ã€‘ {sec['title']}\n\n{sec['text']}"
            for sec in story_sections
        ])

        return story_text, story_sections
    except FileNotFoundError:
        print(f"âŒ {filename} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
        exit(1)

# ===============================================
#  ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜ã‚’ç”Ÿæˆ
# ===============================================
def generate_character_summary(story_text: str) -> str:
    """
    GPT-5.1ã‚’ä½¿ã£ã¦ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜ã‚’ç”Ÿæˆ

    Args:
        story_text: ç‰©èªã®å…¨æ–‡

    Returns:
        str: ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜
    """
    print("ğŸ“ ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜ã‚’ç”Ÿæˆä¸­...")
    print(f"   - æœ¬æ–‡æ–‡å­—æ•°: {len(story_text):,} æ–‡å­—")
    print()

    prompt = f"""
ä»¥ä¸‹ã®ç‰©èªã‹ã‚‰ã€**ã™ã¹ã¦ã®ç™»å ´äººç‰©**ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

æœ¬æ–‡:
{story_text}

è¦ä»¶:
1. **ç™»å ´äººç‰©ã®ç¶²ç¾…æ€§**
   - ä¸»è¦äººç‰©ã¯ã‚‚ã¡ã‚ã‚“ã€è„‡å½¹ã‚„ä¸€æ™‚çš„ã«ç™»å ´ã™ã‚‹äººç‰©ã‚‚å«ã‚ã‚‹
   - å„äººç‰©ã®åå‰ã€ç«‹å ´ã€ç‰¹å¾´ã‚’æ˜è¨˜ã™ã‚‹
   - äººç‰©é–“ã®é–¢ä¿‚æ€§ã‚’æ˜ç¢ºã«ã™ã‚‹

2. **ã‚ã‚‰ã™ã˜ã®æ§‹æˆ**
   - ç‰©èªã®æ™‚ç³»åˆ—ã«æ²¿ã£ã¦å±•é–‹ã‚’è¨˜è¿°
   - å„ç« ã”ã¨ã«ç™»å ´äººç‰©ã‚’æ•´ç†
   - äººç‰©ã®åˆç™»å ´æ™‚ã«ã¯è©³ã—ãèª¬æ˜ã™ã‚‹

3. **å‡ºåŠ›å½¢å¼**
   ä»¥ä¸‹ã®å½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„:

   ## ç™»å ´äººç‰©ä¸€è¦§
   - **äººç‰©å**: ç«‹å ´ãƒ»ç‰¹å¾´ãƒ»å½¹å‰²
   ï¼ˆå…¨ç™»å ´äººç‰©ã‚’åˆ—æŒ™ï¼‰

   ## ã‚ã‚‰ã™ã˜ï¼ˆç« ã”ã¨ï¼‰

   ### ç¬¬1ç« : [ç« ã‚¿ã‚¤ãƒˆãƒ«]
   - ç™»å ´äººç‰©: [ã“ã®ç« ã«ç™»å ´ã™ã‚‹äººç‰©]
   - æ¦‚è¦: [ã“ã®ç« ã®å†…å®¹ã¨äººç‰©ã®å‹•ã]

   ï¼ˆå„ç« ã«ã¤ã„ã¦åŒæ§˜ã«è¨˜è¿°ï¼‰

4. **é‡è¦äº‹é …**
   - äººç‰©åã¯æ­£ç¢ºã«è¨˜è¼‰ï¼ˆèª¤å­—ãƒ»è¡¨è¨˜ã‚†ã‚Œã«æ³¨æ„ï¼‰
   - åŒä¸€äººç‰©ã®åˆ¥åãƒ»æ„›ç§°ã‚‚æ˜è¨˜
   - äººç‰©ã®é–¢ä¿‚æ€§ï¼ˆå®¶æ—ã€å‹äººã€æ•µå¯¾ãªã©ï¼‰ã‚’æ˜ç¢ºã«
   - ã“ã®ã‚ã‚‰ã™ã˜ã¯ã€Œäººç‰©ã«é–¢ã™ã‚‹è³ªå•ã¸ã®å›ç­”ã€ã«ä½¿ç”¨ã•ã‚Œã‚‹ãŸã‚ã€äººç‰©æƒ…å ±ã‚’è©³ç´°ã«è¨˜è¿°

å‡ºåŠ›ã¯Markdownå½¢å¼ã§ã€è¦‹å‡ºã—ã¨ç®‡æ¡æ›¸ãã‚’æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚
"""

    try:
        response = client.chat.completions.create(
            model="gpt-5.1",
            messages=[
                {"role": "system", "content": "ã‚ãªãŸã¯ç‰©èªã®ç™»å ´äººç‰©ã‚’è©³ç´°ã«åˆ†æã—ã€ç¶²ç¾…çš„ãªã‚ã‚‰ã™ã˜ã‚’ä½œæˆã™ã‚‹å°‚é–€å®¶ã§ã™ã€‚"},
                {"role": "user", "content": prompt}
            ],
            temperature=0.3
        )

        summary = response.choices[0].message.content.strip()

        # ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’è¡¨ç¤º
        usage = response.usage
        print(f"âœ… ã‚ã‚‰ã™ã˜ç”Ÿæˆå®Œäº†")
        print(f"   - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒˆãƒ¼ã‚¯ãƒ³: {usage.prompt_tokens:,}")
        print(f"   - å®Œäº†ãƒˆãƒ¼ã‚¯ãƒ³: {usage.completion_tokens:,}")
        print(f"   - åˆè¨ˆãƒˆãƒ¼ã‚¯ãƒ³: {usage.total_tokens:,}")
        print()

        return summary

    except Exception as e:
        print(f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        exit(1)

# ===============================================
#  ã‚ã‚‰ã™ã˜ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
# ===============================================
def save_summary(summary: str, output_file: str = "character_summary.txt"):
    """ã‚ã‚‰ã™ã˜ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜"""
    try:
        with open(output_file, "w", encoding="utf-8") as f:
            f.write("=" * 80 + "\n")
            f.write("ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜\n")
            f.write("=" * 80 + "\n\n")
            f.write(summary)
            f.write("\n\n" + "=" * 80 + "\n")
            f.write(f"ç”Ÿæˆæ—¥æ™‚: {Path(output_file).stat().st_mtime}\n")
            f.write("=" * 80 + "\n")

        print(f"ğŸ’¾ ã‚ã‚‰ã™ã˜ã‚’ {output_file} ã«ä¿å­˜ã—ã¾ã—ãŸ")
        print(f"   - ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: {Path(output_file).stat().st_size:,} ãƒã‚¤ãƒˆ")

        # æ–‡å­—æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        char_count = len(summary)
        print(f"   - æ–‡å­—æ•°: {char_count:,} æ–‡å­—")

        return output_file

    except Exception as e:
        print(f"âŒ ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        exit(1)

# ===============================================
#  ãƒ¡ã‚¤ãƒ³å‡¦ç†
# ===============================================
def main():
    print("=" * 80)
    print("ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜ç”Ÿæˆ")
    print("=" * 80)
    print()

    # 1. å°èª¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    print("ğŸ“– å°èª¬ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...")
    story_text, story_sections = load_story()
    print(f"   - ç·ç« æ•°: {len(story_sections)}")
    print(f"   - ç·æ–‡å­—æ•°: {len(story_text):,} æ–‡å­—")
    print()

    # 2. ç™»å ´äººç‰©ã‚’ç¶²ç¾…ã—ãŸã‚ã‚‰ã™ã˜ã‚’ç”Ÿæˆ
    summary = generate_character_summary(story_text)

    # 3. ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
    output_file = save_summary(summary)

    print()
    print("=" * 80)
    print("âœ… å®Œäº†!")
    print("=" * 80)
    print()
    print("ç”Ÿæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:")
    print(f"  - {output_file}")
    print()
    print("ã“ã®ã‚ã‚‰ã™ã˜ã¯ä»¥ä¸‹ã®ç”¨é€”ã§ä½¿ç”¨ã§ãã¾ã™:")
    print("  1. è³ªå•ãŒç™»å ´äººç‰©ã«é–¢ã™ã‚‹ã‚‚ã®ã‹ã®åˆ¤å®š")
    print("  2. è³ªå•ã®ä¸­å¿ƒã¨ãªã‚‹äººç‰©ã®ç‰¹å®š")
    print()

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\n\nâš ï¸  ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ä¸­æ–­ã•ã‚Œã¾ã—ãŸ")
    except Exception as e:
        print(f"\n\nâŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        import traceback
        traceback.print_exc()
